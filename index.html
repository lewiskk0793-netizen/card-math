<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>å…­å¼µç®—è¡“ - å°æˆ°ç‰ˆ</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Helvetica Neue', sans-serif;
      background: #f0f5ff;
      margin: 0;
      padding: 16px;
      color: #333;
      touch-action: manipulation;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-top: 0;
      font-size: 24px;
    }

    /* å°æˆ°è³‡è¨Š */
    .battle-info {
      text-align: center;
      margin: 10px 0;
      font-weight: bold;
      color: #e17055;
    }
    .opponent-status {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 6px;
      margin: 8px 0;
      font-size: 14px;
    }

    /* è¨ˆåˆ†èˆ‡è¨ˆæ™‚ */
    .score-time {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-weight: bold;
      align-items: center;
    }
    .timer-setting {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .timer-bar {
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 4px;
    }
    .timer-fill {
      height: 100%;
      background: #0984e3;
      width: 100%;
      transition: width 0.1s linear;
    }

    /* ç›®æ¨™å¡ */
    .target-row {
      display: flex;
      justify-content: center;
      margin: 12px 0;
    }
    .target-card {
      width: 60px;
      height: 76px;
      border: 2px solid #d63031;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      background: #ffeaa7;
    }

    /* æ‰‹ç‰Œå€ */
    .hand-area {
      min-height: 100px;
      margin: 12px 0;
      padding: 12px;
      background: #fafafa;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      align-items: center;
    }

    .card {
      width: 56px;
      height: 76px;
      border: 2px solid #333;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      font-weight: bold;
      background: white;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.2s;
    }

    .card.selected-first {
      border-color: #0984e3;
      transform: scale(1.05);
      box-shadow: 0 0 12px rgba(9, 132, 227, 0.6);
    }

    .card.new-glow {
      animation: newCardGlow 1.2s ease-out;
    }

    @keyframes newCardGlow {
      0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
      50% { box-shadow: 0 0 16px 4px rgba(40, 167, 69, 0.8); }
      100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }

    /* é‹ç®—é¸å–® */
    .operator-menu {
      display: none;
      justify-content: center;
      gap: 10px;
      margin: 12px 0;
      flex-wrap: wrap;
    }
    .op-btn {
      width: 48px;
      height: 48px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 50%;
      background: #0984e3;
      color: white;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .cancel-btn {
      padding: 8px 16px;
      background: #ff7675;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      -webkit-tap-highlight-color: transparent;
    }

    .buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 16px 0;
    }
    button {
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #0984e3;
      color: white;
      font-weight: bold;
      -webkit-tap-highlight-color: transparent;
    }
    #hintBtn { background: #00b894; }
    #nextBtn { background: #fdcb6e; color: #2d3436; }
    #resetBtn { background: #a29bfe; }
    #helpBtn { background: #6c5ce7; }

    .message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
    }
    .success { background: #d5f4e6; color: #00a86b; }
    .error { background: #ffdddd; color: #d63031; }
    .info { background: #e3f2fd; color: #0984e3; }

    /* ç©æ³•èªªæ˜ Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.6);
      overflow: auto;
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      border-radius: 12px;
      max-width: 500px;
      margin-left: 16px;
      margin-right: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      max-height: 80vh;
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .instructions h2 {
      margin-top: 0;
      color: #2c3e50;
    }
    .instructions ul {
      padding-left: 20px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸƒ å…­å¼µç®—è¡“ - å°æˆ°ç‰ˆ</h1>
    
    <!-- å°æˆ°æˆ¿é–“ -->
    <div class="battle-info" id="battleInfo">ç­‰å¾…å°æ‰‹åŠ å…¥...</div>
    <div class="opponent-status" id="opponentStatus">å°æ‰‹ç‹€æ…‹ï¼šæœªé€£ç·š</div>
    
    <!-- è¨ˆåˆ†èˆ‡è¨ˆæ™‚ -->
    <div class="score-time">
      <div>ğŸ† ä½ çš„åˆ†æ•¸: <span id="score">0</span></div>
      <div class="timer-setting">
        <label for="timeSelect">â±ï¸ æ™‚é–“:</label>
        <select id="timeSelect" onchange="changeTimeLimit()" disabled>
          <option value="10">10 ç§’</option>
          <option value="15">15 ç§’</option>
          <option value="20">20 ç§’</option>
          <option value="30">30 ç§’</option>
        </select>
        <span id="timeLeft">10</span>s
      </div>
    </div>
    <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>

    <div class="target-row">
      <div class="target-card" id="targetCard">?</div>
    </div>
    <div class="hand-area" id="handArea"></div>
    
    <div class="operator-menu" id="operatorMenu">
      <button class="op-btn" onclick="selectOperator('+')">+</button>
      <button class="op-btn" onclick="selectOperator('âˆ’')">âˆ’</button>
      <button class="op-btn" onclick="selectOperator('Ã—')">Ã—</button>
      <button class="op-btn" onclick="selectOperator('Ã·')">Ã·</button>
      <button class="cancel-btn" onclick="cancelSelection()">å–æ¶ˆ</button>
    </div>

    <div class="buttons">
      <button id="hintBtn" onclick="showHint()">æç¤º</button>
      <button id="nextBtn" onclick="newGame()" disabled>æ›ä¸€é¡Œ</button>
      <button id="resetBtn" onclick="resetHand()">é‡ä¾†</button>
      <button id="helpBtn" onclick="openInstructions()">ç©æ³•èªªæ˜</button>
    </div>
    <div id="message" class="message info">ğŸ¯ é»æ“Šç¬¬ä¸€å¼µå¡ç‰Œï¼</div>
  </div>

  <!-- ç©æ³•èªªæ˜ Modal -->
  <div id="instructionsModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeInstructions()">&times;</span>
      <div class="instructions">
        <h2>ğŸ® å°æˆ°ç©æ³•</h2>
        <ul>
          <li><strong>è¦å‰‡</strong>ï¼šé›™æ–¹ç©ç›¸åŒé¡Œç›®ï¼Œå…ˆç®—å‡ºæ­£ç¢ºç­”æ¡ˆè€…ç²å‹</li>
          <li><strong>æ“ä½œ</strong>ï¼š
            <br>1. é»æ“Šç¬¬ä¸€å¼µå¡
            <br>2. é¸æ“‡é‹ç®—ç¬¦
            <br>3. é»æ“Šç¬¬äºŒå¼µå¡
          </li>
          <li><strong>é™åˆ¶</strong>ï¼š
            <br>â€¢ ä¸èƒ½è² æ•¸
            <br>â€¢ é™¤æ³•å¿…é ˆæ•´é™¤
          </li>
        </ul>
        <p style="text-align:center; margin-top:16px;">
          <button onclick="closeInstructions()" style="padding:8px 16px; background:#0984e3; color:white; border:none; border-radius:6px;">
            é–‹å§‹å°æˆ°ï¼
          </button>
        </p>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // ğŸ”¥ TODO: æ›¿æ›ç‚ºä½ çš„ Firebase è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyDKhY2D5EES-01B4YQ2iymfKa2V6GrfcFU",
      authDomain: "card-math.firebaseapp.com",
      databaseURL: "https://card-math-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "card-math",
      storageBucket: "card-math.firebasestorage.app",
      messagingSenderId: "429102092258",
      appId: "1:429102092258:web:5451d782914285b6de33bb"
    };

    // ğŸ”¥ ä¿®æ­£ï¼šdatabase å®£å‘Šåœ¨å…¨åŸŸ
    let database = null;

    // åˆå§‹åŒ– Firebase
    try {
      firebase.initializeApp(firebaseConfig);
      database = firebase.database();
    } catch (e) {
      console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
      document.getElementById('message').textContent = 'âš ï¸ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥è¨­å®š';
      document.getElementById('message').className = 'message error';
    }

    // === éŠæˆ²ç‹€æ…‹ ===
    let currentTarget = null;
    let originalHand = [];
    let selectedCard1 = null;
    let selectedOperator = null;
    let score = 0;
    let timeLeft = 10;
    let timer = null;
    let currentTimeLimit = 10;
    let isGameActive = false;
    let roomId = null;
    let playerId = null;
    let opponentId = null;
    let moveCount = 0;

    // ç”Ÿæˆéš¨æ©Ÿæˆ¿é–“ ID
    function generateRoomId() {
      return Math.random().toString(36).substr(2, 6).toUpperCase();
    }

    // ğŸ”¥ ä¿®æ­£ç‰ˆï¼šjoinRoom å‡½æ•¸
    function joinRoom(roomId) {
      this.roomId = roomId;
      playerId = 'player_' + Date.now();
      
      const roomRef = database.ref('rooms/' + roomId);
      
      // ç›£è½æˆ¿é–“ç‹€æ…‹
      roomRef.on('value', (snapshot) => {
        const data = snapshot.val();
        
        if (!data) {
          // æˆ¿é–“ä¸å­˜åœ¨ï¼Œå‰µå»ºæ–°æˆ¿é–“
          roomRef.set({
            players: { [playerId]: true },
            gameState: 'waiting',
            puzzle: null
          });
          document.getElementById('battleInfo').textContent = `æˆ¿é–“ä»£è™Ÿ: ${ roomId} (ç­‰å¾…å°æ‰‹...)`;
          return;
        }
        
        // æª¢æŸ¥ç©å®¶æ•¸é‡
        const players = data.players || {};
        const playerIds = Object.keys(players);
        const playerCount = playerIds.length;
        
        if (playerCount >= 2 && data.gameState !== 'active') {
          // é›™æ–¹å·²åŠ å…¥ï¼Œé–‹å§‹éŠæˆ²
          createNewGame();
        } else if (playerCount >= 2 && data.gameState === 'active' && data.puzzle) {
          // éŠæˆ²å·²é–‹å§‹ï¼ŒåŠ å…¥ç¾æœ‰éŠæˆ²
          startBattleGame(data.puzzle);
        } else {
          document.getElementById('battleInfo').textContent = `æˆ¿é–“ä»£è™Ÿ: ${ roomId} (ç­‰å¾…å°æ‰‹...)`;
        }
        
        // è¨˜éŒ„å°æ‰‹ ID
        for (let id in players) {
          if (id !== playerId) {
            opponentId = id;
            break;
          }
        }
      });

      // ç›£è½å°æ‰‹å‹•ä½œ
      roomRef.child('moves').on('child_added', (snapshot) => {
        const move = snapshot.val();
        if (move.playerId !== playerId) {
          updateOpponentStatus(move.moveCount);
        }
      });
    }

    // ğŸ”¥ ä¿®æ­£ç‰ˆï¼šcreateNewGame å‡½æ•¸
    function createNewGame() {
      const PUZZLE_BANK = [
        { ops: [13, 1, 1, 1, 1], target: 10 },
        { ops: [6, 2, 2, 1, 1], target: 10 },
        { ops: [8, 2, 2, 1, 1], target: 10 },
        { ops: [12, 3, 2, 1, 1], target: 10 },
        { ops: [10, 2, 2, 1, 1], target: 13 }
      ];
      const p = PUZZLE_BANK[Math.floor(Math.random() * PUZZLE_BANK.length)];
      
      // å»£æ’­éŠæˆ²é–‹å§‹
      database.ref('rooms/' + roomId).update({
        gameState: 'active',
        puzzle: p,
        startTime: firebase.database.ServerValue.TIMESTAMP
      });
      
      startBattleGame(p);
    }

    // é–‹å§‹å°æˆ°éŠæˆ²
    function startBattleGame(puzzle) {
      currentTarget = puzzle.target;
      originalHand = [...puzzle.ops];
      document.getElementById('targetCard').textContent = valueToDisplay(currentTarget);

      const handArea = document.getElementById('handArea');
      handArea.innerHTML = '';
      for (let i = 0; i < puzzle.ops.length; i++) {
        handArea.appendChild(createCard(puzzle.ops[i]));
      }

      clearSelection();
      startTimer();
      showMessage('ğŸ¯ å°æˆ°é–‹å§‹ï¼å…ˆç®—å‡ºç­”æ¡ˆè€…ç²å‹ï¼', 'info');
      
      // å•Ÿç”¨æŒ‰éˆ•
      document.getElementById('timeSelect').disabled = true;
      document.getElementById('nextBtn').disabled = true;
    }

    // === å·¥å…·å‡½æ•¸ ===
    const VALUE_TO_RANK = {1:'A',2:'2',3:'3',4:'4',5:'5',6:'6',7:'7',8:'8',9:'9',10:'10',11:'J',12:'Q',13:'K'};
    const SUITS = ['â™ ','â™¥','â™¦','â™£'];

    function getRandomSuit() {
      return SUITS[Math.floor(Math.random() * SUITS.length)];
    }

    function valueToDisplay(value) {
      if (value >= 1 && value <= 13) {
        return VALUE_TO_RANK[value] + getRandomSuit();
      }
      return String(Math.round(value * 100) / 100);
    }

    function createCard(value, isNew = false) {
      const card = document.createElement('div');
      card.className = 'card';
      if (isNew) card.classList.add('new-glow');
      card.textContent = valueToDisplay(value);
      card.dataset.value = value;
      card.id = 'card-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      card.onclick = (e) => {
        e.stopPropagation();
        selectCard(card);
      };
      return card;
    }

    // === æ ¸å¿ƒé‚è¼¯ ===
    function selectCard(card) {
      if (!isGameActive) return;
      
      if (selectedOperator !== null) {
        if (card === selectedCard1) {
          showMessage('ä¸èƒ½èˆ‡è‡ªå·±é‹ç®—ï¼', 'error');
          return;
        }
        performCalculation(card);
        return;
      }

      if (selectedCard1 === null) {
        selectedCard1 = card;
        card.classList.add('selected-first');
        document.getElementById('operatorMenu').style.display = 'flex';
        showMessage('å·²é¸æ“‡ç¬¬ä¸€å¼µå¡ï¼Œè«‹é¸æ“‡é‹ç®—ç¬¦', 'info');
        return;
      }

      if (card === selectedCard1) {
        clearSelection();
        showMessage('å·²å–æ¶ˆé¸æ“‡', 'info');
        return;
      }

      showMessage('è«‹å…ˆé¸æ“‡é‹ç®—ç¬¦ï¼', 'error');
    }

    function selectOperator(op) {
      if (selectedCard1 === null || !isGameActive) return;
      selectedOperator = op;
      showMessage('å·²é¸æ“‡ "' + op + '"ï¼Œè«‹é»æ“Šç¬¬äºŒå¼µå¡', 'info');
    }

    function performCalculation(secondCard) {
      if (!isGameActive) return;
      
      const val1 = parseFloat(selectedCard1.dataset.value);
      const val2 = parseFloat(secondCard.dataset.value);
      let result;

      switch(selectedOperator) {
        case '+': result = val1 + val2; break;
        case 'âˆ’': result = val1 - val2; break;
        case 'Ã—': result = val1 * val2; break;
        case 'Ã·':
          if (Math.abs(val2) < 1e-9) {
            showMessage('âŒ ä¸èƒ½é™¤ä»¥é›¶ï¼', 'error');
            clearSelection();
            return;
          }
          if (Math.abs(val1 % val2) > 1e-9) {
            showMessage('âŒ é™¤æ³•çµæœå¿…é ˆç‚ºæ•´æ•¸ï¼', 'error');
            clearSelection();
            return;
          }
          result = val1 / val2;
          break;
        default:
          clearSelection();
          return;
      }

      if (result < 0) {
        showMessage('âŒ çµæœä¸èƒ½ç‚ºè² æ•¸ï¼', 'error');
        clearSelection();
        return;
      }

      // ç§»é™¤å¡ç‰Œ
      selectedCard1.remove();
      secondCard.remove();

      // æ–°å¢çµæœå¡
      const newCard = createCard(result, true);
      document.getElementById('handArea').appendChild(newCard);

      clearSelection();
      moveCount++;
      
      // åŒæ­¥å‹•ä½œåˆ° Firebase
      if (roomId) {
        database.ref('rooms/' + roomId + '/moves').push({
          playerId: playerId,
          moveCount: moveCount,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        });
      }

      // æª¢æŸ¥æ˜¯å¦å®Œæˆ
      const remainingCards = document.querySelectorAll('.card');
      if (remainingCards.length === 1) {
        const finalValue = parseFloat(remainingCards[0].dataset.value);
        if (Math.abs(finalValue - currentTarget) < 1e-6) {
          // å»£æ’­å‹åˆ©
          if (roomId) {
            database.ref('rooms/' + roomId + '/winner').set({
              playerId: playerId,
              timestamp: firebase.database.ServerValue.TIMESTAMP
            });
          }
          showMessage('ğŸ‰ ä½ è´äº†ï¼', 'success');
          clearInterval(timer);
          isGameActive = false;
        } else {
          showMessage('âŒ çµæœéŒ¯èª¤ï¼', 'error');
          clearInterval(timer);
          isGameActive = false;
        }
      }
    }

    // === è¨ˆæ™‚ç³»çµ± ===
    function startTimer() {
      if (timer) clearInterval(timer);
      timeLeft = currentTimeLimit;
      isGameActive = true;
      updateTimerUI();
      
      timer = setInterval(() => {
        timeLeft--;
        updateTimerUI();
        if (timeLeft <= 0) {
          clearInterval(timer);
          isGameActive = false;
          showMessage('â° æ™‚é–“åˆ°ï¼', 'error');
        }
      }, 1000);
    }

    function updateTimerUI() {
      const timeElement = document.getElementById('timeLeft');
      if (timeElement) timeElement.textContent = timeLeft;
      
      const fill = document.getElementById('timerFill');
      if (fill) {
        const percent = Math.max(0, timeLeft / currentTimeLimit * 100);
        fill.style.width = percent + '%';
        if (timeLeft <= Math.ceil(currentTimeLimit * 0.3)) {
          fill.style.background = '#d63031';
        } else {
          fill.style.background = '#0984e3';
        }
      }
    }

    // === å°æ‰‹ç‹€æ…‹æ›´æ–° ===
    function updateOpponentStatus(count) {
      document.getElementById('opponentStatus').textContent = `å°æ‰‹ç‹€æ…‹ï¼šå·²åˆä½µ ${count} æ¬¡`;
    }

    // === å…¶ä»–å‡½æ•¸ ===
    function clearSelection() {
      if (selectedCard1) {
        selectedCard1.classList.remove('selected-first');
        selectedCard1 = null;
      }
      selectedOperator = null;
      document.getElementById('operatorMenu').style.display = 'none';
    }

    function cancelSelection() {
      clearSelection();
      showMessage('å·²å–æ¶ˆé¸æ“‡', 'info');
    }

    function resetHand() {
      if (!isGameActive) return;
      clearSelection();
      const handArea = document.getElementById('handArea');
      handArea.innerHTML = '';
      for (let i = 0; i < originalHand.length; i++) {
        handArea.appendChild(createCard(originalHand[i]));
      }
      startTimer();
      showMessage('å·²é‡è¨­æ‰‹ç‰Œ', 'info');
    }

    function showHint() {
      showMessage('ğŸ’¡ æç¤ºï¼šå…ˆé¸å°æ•¸å­—ä½œç‚ºç¬¬ä¸€å¼µå¡ï¼', 'info');
    }

    function showMessage(text, type) {
      const msg = document.getElementById('message');
      msg.textContent = text;
      msg.className = 'message ' + type;
    }

    function changeTimeLimit() {
      const select = document.getElementById('timeSelect');
      const newLimit = parseInt(select.value);
      if (newLimit !== currentTimeLimit) {
        currentTimeLimit = newLimit;
        document.getElementById('timeLeft').textContent = currentTimeLimit;
      }
    }

    // === åˆå§‹åŒ– ===
    document.addEventListener('DOMContentLoaded', () => {
      // æª¢æŸ¥ Firebase æ˜¯å¦åˆå§‹åŒ–æˆåŠŸ
      if (!database) {
        document.getElementById('message').textContent = 'âš ï¸ Firebase æœªåˆå§‹åŒ–ï¼Œè«‹æª¢æŸ¥è¨­å®š';
        document.getElementById('message').className = 'message error';
        return;
      }
      
      // å‰µå»ºæˆ–åŠ å…¥æˆ¿é–“
      const urlParams = new URLSearchParams(window.location.search);
      let roomId = urlParams.get('room');
      
      if (!roomId) {
        roomId = generateRoomId();
        // é‡æ–°å°å‘åˆ°å¸¶æˆ¿é–“ ID çš„ URL
        window.history.replaceState({}, '', `?room=${roomId}`);
      }
      
      joinRoom(roomId);
      
      // åˆå§‹åŒ– UI
      document.getElementById('timeSelect').value = currentTimeLimit.toString();
      document.getElementById('timeLeft').textContent = currentTimeLimit;
    });

    // Modal å‡½æ•¸
    function openInstructions() {
      document.getElementById('instructionsModal').style.display = 'block';
    }
    function closeInstructions() {
      document.getElementById('instructionsModal').style.display = 'none';
    }
    window.onclick = function(event) {
      const modal = document.getElementById('instructionsModal');
      if (event.target === modal) closeInstructions();
    };
  </script>
</body>
</html>
